#!/bin/bash
set -e

# Create system user and group
if ! getent passwd boxvault > /dev/null 2>&1; then
    adduser --system --group --home /opt/boxvault \
            --no-create-home --shell /usr/sbin/nologin \
            --gecos "BoxVault system user" boxvault
fi

# Set ownership and permissions
chown -R boxvault:boxvault /opt/boxvault
chown -R boxvault:boxvault /var/lib/boxvault
chown -R boxvault:boxvault /var/log/boxvault
chown -R boxvault:boxvault /etc/boxvault


# Generate JWT secret if it doesn't exist and update auth config (only on fresh install)
case "$1" in
    configure)
        if [ -z "$2" ]; then
            # Fresh install (no previous version)
            if [ -f /etc/boxvault/auth.config.yaml ]; then
                if grep -q "CHANGE_THIS_SECRET_KEY_IN_PRODUCTION" /etc/boxvault/auth.config.yaml; then
                    JWT_SECRET=$(openssl rand -hex 32)
                    sed -i "s/CHANGE_THIS_SECRET_KEY_IN_PRODUCTION/${JWT_SECRET}/g" /etc/boxvault/auth.config.yaml
                    echo "Generated and updated JWT secret in auth.config.yaml"
                fi
            fi
        else
            # Upgrade (previous version exists) - don't modify existing configs
            echo "Upgrade detected - preserving existing configuration files"
        fi
        ;;
esac

# Initialize directories for BoxVault
mkdir -p /var/lib/boxvault/uploads
mkdir -p /var/log/boxvault
chown boxvault:boxvault /var/lib/boxvault/uploads
chown boxvault:boxvault /var/log/boxvault

# Generate setup token during installation
SETUP_TOKEN=$(openssl rand -hex 32)
echo "$SETUP_TOKEN" > /etc/boxvault/setup.token
chown boxvault:boxvault /etc/boxvault/setup.token
chmod 600 /etc/boxvault/setup.token

# Reload systemd daemon
systemctl daemon-reload

echo ""
echo "======================================================================"
echo "BoxVault has been installed successfully!"
echo ""
echo "SETUP TOKEN (save this for initial configuration):"
echo "  $SETUP_TOKEN"
echo ""
echo "Next steps:"
echo "1. Start the service: systemctl enable --now boxvault"
echo "2. Access BoxVault at: http://localhost:3000"
echo "3. Use the setup token above for initial configuration"
echo "4. Check status: systemctl status boxvault"
echo "5. View logs: journalctl -u boxvault -f"
echo ""
echo "Configuration files location: /etc/boxvault/"
echo "======================================================================"
echo ""

#DEBHELPER#
